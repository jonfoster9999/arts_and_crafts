<br>
<h2><%= @project.title %> (<span id="rating"><%= @project.average_rating %></span>/5.0 average rating) </h2>
<% if current_user.id == @project.user_id %>
	<%= link_to "Edit", edit_user_project_path(@user, @project) %>
	<%= link_to "Delete", user_project_path(@user, @project), :method => :delete %>
<% end %>
<h5>by <%= link_to @user.name, user_path(@user) %></h5>

<div class = "description">
	Description:<p><%= @project.description %></p>
</div>

<div class="supplies">
	Supplies:<br>
	----------------------
	<% if !@project.supplies.empty? %>
		<ul class="list_of_supplies">
			<%= render :partial => "supply", :collection => @project.supplies.uniq %>
			----------------------
			<li class="supply_list">Total Cost: $<%= @project.total_price %></li>

		</ul>
	<% else %>
		<p>No supplies listed.</p>
	<% end %>
</div>
<br>
<div class="comment_form">
	Write a review:
	<%= render :partial => "comment_form", locals: {project: @project, review: @review} %>
</div>
<h3>Reviews: </h3>
<ul class="project_comments">
		<%= render :partial => "review", :collection => @project.reviews %>
<script>

$(function(){
	/////////////
	//variables// 
	/////////////

	var projectUrl = window.location.href + ".json";
	var form = $('form')

	//generic get function
 	function getProjectInfo (callback) {
 		$.get(projectUrl)
 			.success(callback)
 		}

 	/////////////
 	//callbacks//
 	/////////////

 	function buildHtmlCallback(response) {

 		///////////////////////
 		//TODO: BUILD MY VIEW//
 		///////////////////////

 		console.log(response, "HEARD CLICK")
 	}
	
	function reviewCallback(response) {
			//gets the new version of the project after the review is added, aka reviews length 
			// increases by one and project.averageReview() returns updated info.	
		var myProject = new ProjectForShowPage(response)
		//UPDATE CURRENT AVERAGE RATING TO NEW AVERAGE RATING
		$('#rating').text(myProject.averageRating())
	}

	//constructor
	function ProjectForShowPage(productHash) {
		for (key in productHash) {
			this[key] = productHash[key]
			//make this available site wide?
		}
	}

	//constructor prototype
	ProjectForShowPage.prototype.averageRating = function(){
		var ratingTotal = 0;
		var numberOfReviews = this.reviews.length;
		for(var i = 0, n = this.reviews.length; i < n; i++) {
			ratingTotal += this.reviews[i].rating;
		}
		return (ratingTotal/numberOfReviews).toFixed(1)
	}

	//review submission

	form.submit(function(e){
		e.preventDefault();
		form.removeClass('hidden');
 		$.post(this.action, form.serialize())
 			.success(function(data){
 				
 				//handles updating the average review
 				getProjectInfo(reviewCallback);
 				/////////////////////////////////////

 				form.each(function(){
 					this.reset();
 				})
 				$('#submit').attr("disabled", false)
 				$('.project_comments').append(data)
 			})
	})

	//populate show page
	getProjectInfo(buildHtmlCallback)
})

</script>